SPIN?=spin
CC=gcc
CFLAGS=-O2

# We are testing the sources, not the installed application
SDL2PROMELA=PYTHONPATH=../../../ python3 -m sdl2promela.sdl2promela

RES_DIR=resources

TEST_DIR=out

CREATE_EMPTY_TEST_DIR=rm -r -f ${TEST_DIR} && mkdir -p ${TEST_DIR}
DELETE_TEST_DIR=rm -r ${TEST_DIR}

TESTS = \
	test_stop_condition_queue_last_integer_ok \
	test_stop_condition_queue_last_integer_error \
	test_stop_condition_queue_last_sequence1_ok \
	test_stop_condition_queue_last_sequence1_error \
	test_stop_condition_queue_last_sequence2_ok \
	test_stop_condition_queue_last_sequence2_error \
	test_stop_condition_queue_last_choice_ok \
	test_stop_condition_queue_last_choice_error \
	test_stop_condition_queue_last_array_ok \
	test_stop_condition_queue_last_array_error \
	test_stop_condition_queue_last_optional_ok \
	test_stop_condition_queue_last_optional_error

.SILENT : \
	${TESTS}

.PHONY : \
	${TESTS} \
	check

check: ${TESTS}

##############################INTEGRATION TESTS################################

# These tests are created based on the tests supplied with custom Spin version
# used by N7 Space (see github.com/n7space/Spin). Their purpose is to validate
# whether the generated Promela code actually works inside Spin.
# As sdl2promela generates only inlines (representing the SDL logic) which need
# external data and process definitions (similarly to opengeode generating
# only C functions, which need type declarations generated by asn1scc and
# glue code generated by Kazoo), they are wrapped inside "host" Promela
# files

# In this test the model checker shouldn't find an error.
test_stop_condition_queue_last_integer_ok:
	echo "Test stop_condition_queue_last_integer ok"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 0" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker should find an error.
test_stop_condition_queue_last_integer_error:
	echo "Test stop_condition_queue_last_integer error"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 1" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}


# In this test the model checker shouldn't find an error.
test_stop_condition_queue_last_sequence1_ok:
	echo "Test stop_condition_queue_last_sequence1 ok"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_sequence1.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 0" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker should find an error.
test_stop_condition_queue_last_sequence1_error:
	echo "Test stop_condition_queue_last_sequence1 error"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_sequence1.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 1" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker shouldn't find an error.
test_stop_condition_queue_last_sequence2_ok:
	echo "Test stop_condition_queue_last_sequence2 ok"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_sequence2.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 0" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker should find an error.
test_stop_condition_queue_last_sequence2_error:
	echo "Test stop_condition_queue_last_sequence2 error"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_sequence2.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 1" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker shouldn't find an error.
test_stop_condition_queue_last_choice_ok:
	echo "Test stop_condition_queue_last_choice ok"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_choice.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 0" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker should find an error.
test_stop_condition_queue_last_choice_error:
	echo "Test stop_condition_queue_last_choice error"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_choice.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 1" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker shouldn't find an error.
test_stop_condition_queue_last_array_ok:
	echo "Test stop_condition_queue_last_array ok"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_array.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 0" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker should find an error.
test_stop_condition_queue_last_array_error:
	echo "Test stop_condition_queue_last_array error"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_array.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 1" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker shouldn't find an error.
test_stop_condition_queue_last_optional_ok:
	echo "Test stop_condition_queue_last_optional ok"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_optional.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 0" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}

# In this test the model checker should find an error.
test_stop_condition_queue_last_optional_error:
	echo "Test stop_condition_queue_last_optional error"
	${CREATE_EMPTY_TEST_DIR}
	${SDL2PROMELA} -v -o ${TEST_DIR}/controller.pml --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/actuator.pml --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	${SDL2PROMELA} -v -o ${TEST_DIR}/scl.pml --scl ${RES_DIR}/scl_optional.txt --sdl ${RES_DIR}/taste/work/controller/SDL/src/system_structure.pr ${RES_DIR}/taste/work/controller/SDL/src/controller_bad.pr --sdl ${RES_DIR}/taste/work/actuator/SDL/src/system_structure.pr ${RES_DIR}/taste/work/actuator/SDL/src/actuator.pr
	cp ${RES_DIR}/tmc/dataview.pml ${TEST_DIR}/dataview.pml
	cp ${RES_DIR}/tmc/system.pml ${TEST_DIR}/system.pml
	cp ${RES_DIR}/tmc/env_inlines.pml ${TEST_DIR}/env_inlines.pml
	cd ${TEST_DIR} && \
	${SPIN} -a -m system.pml
	$(CC) -o ${TEST_DIR}/pan ${TEST_DIR}/pan.c $(CFLAGS) -DNFAIR=3 -DVECTORSZ=2048
	cd ${TEST_DIR} && \
	./pan -a -f -n -m1000000 > system.output
	grep -q "errors: 1" ${TEST_DIR}/system.output
	${DELETE_TEST_DIR}
